# تحديث إدارة الجلسات - Session Management Update

## التغييرات المطبقة

### 1. **تعديل نظام الحماية من تسجيل الدخول المتزامن**

#### قبل التحديث:
- جميع المستخدمين (أدمن، كاشير، عميل) لا يمكنهم تسجيل الدخول من أكثر من جهاز في نفس الوقت

#### بعد التحديث:
- **العملاء فقط**: لا يمكنهم تسجيل الدخول من أكثر من جهاز في نفس الوقت
- **الأدمن والكاشير**: يمكنهم تسجيل الدخول من عدة أجهزة في نفس الوقت

### 2. **الملفات المعدلة**

#### `app/auth/session_service.py`
- تعديل `create_session()`: إلغاء الجلسات السابقة للعملاء فقط
- إضافة `deactivate_customer_sessions()`: إلغاء جلسات العملاء فقط
- إضافة `get_active_sessions_count()`: عدد الجلسات النشطة
- إضافة `get_user_active_sessions()`: قائمة الجلسات النشطة

#### `app/auth/router.py`
- إضافة `GET /auth/sessions/active`: عرض الجلسات النشطة للمستخدم
- إضافة `DELETE /auth/sessions/{session_id}`: إلغاء جلسة معينة

### 3. **كيف يعمل النظام الجديد**

#### للعملاء (CUSTOMER):
```python
# عند تسجيل الدخول
if user.role == UserRole.CUSTOMER:
    await SessionService.deactivate_customer_sessions(user.id)  # إلغاء الجلسات السابقة
```

#### للأدمن والكاشير (ADMIN/CASHIER):
```python
# عند تسجيل الدخول
# لا يتم إلغاء الجلسات السابقة - يمكن الدخول من عدة أجهزة
```

### 4. **APIs الجديدة**

#### عرض الجلسات النشطة:
```http
GET /auth/sessions/active
Authorization: Bearer <token>
```

**الاستجابة:**
```json
{
  "user_id": "user_id",
  "role": "admin",
  "active_sessions_count": 3,
  "sessions": [
    {
      "id": "session_id",
      "created_at": "2024-01-01T10:00:00Z",
      "last_used": "2024-01-01T12:00:00Z",
      "expires_at": "2024-01-02T10:00:00Z",
      "is_active": true
    }
  ]
}
```

#### إلغاء جلسة معينة:
```http
DELETE /auth/sessions/{session_id}
Authorization: Bearer <token>
```

**الاستجابة:**
```json
{
  "message": "Session deactivated successfully"
}
```

### 5. **الفوائد**

#### للأدمن والكاشير:
- ✅ يمكن العمل من عدة أجهزة (كمبيوتر، تابلت، موبايل)
- ✅ مرونة أكبر في العمل
- ✅ لا توجد مقاطعة عند تسجيل الدخول من جهاز جديد

#### للعملاء:
- ✅ حماية أمنية عالية
- ✅ منع الاستخدام غير المصرح به
- ✅ حماية البيانات الشخصية

### 6. **الاختبار**

#### اختبار الأدمن/الكاشير:
1. سجل دخول من الكمبيوتر
2. سجل دخول من الموبايل
3. ✅ يجب أن يعمل كلا الجهازين

#### اختبار العملاء:
1. سجل دخول العميل من الكمبيوتر
2. سجل دخول العميل من الموبايل
3. ✅ يجب أن يتم إلغاء جلسة الكمبيوتر تلقائياً

### 7. **التراجع عن التغييرات**

إذا كنت تريد العودة للنظام السابق، قم بتعديل `create_session()`:

```python
# العودة للنظام السابق
await SessionService.deactivate_user_sessions(user.id)  # لجميع المستخدمين
```

## الخلاصة

تم تطبيق التحديث بنجاح! الآن الأدمن والكاشير يمكنهم العمل من عدة أجهزة، بينما العملاء محميون من تسجيل الدخول المتزامن.
